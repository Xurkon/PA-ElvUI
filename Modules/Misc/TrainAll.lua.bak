local E, L, V, P, G = unpack(select(2, ...))
local TrainAll = E:NewModule("TrainAll", "AceHook-3.0", "AceEvent-3.0")

local select = select
local format = string.format

local BuyTrainerService = BuyTrainerService
local CreateFrame = CreateFrame
local GetMoney = GetMoney
local GetNumTrainerServices = GetNumTrainerServices
local GetTrainerServiceCost = GetTrainerServiceCost
local GetTrainerServiceInfo = GetTrainerServiceInfo
local IsAddOnLoaded = IsAddOnLoaded

local function BetterSafeThanSorry_OnUpdate(button, elapsed)
	button.delay = button.delay - elapsed

	if button.delay <= 0 then
		TrainAll:ResetScript()
	end
end

function TrainAll:TrainAllSkills()
	self.locked = true
	self.button:Disable()

	local learned, cost = 0
	local money = GetMoney()

	for i = 1, GetNumTrainerServices() do
		if select(3, GetTrainerServiceInfo(i)) == "available" then
			learned = learned + 1
			cost = GetTrainerServiceCost(i)

			if money >= cost then
				money = money - cost
				BuyTrainerService(i)
			else
				self:ResetScript()
				return
			end
		end
	end

	if learned > 0 then
		self.skillsToLearn = learned
		self.skillsLearned = 0

		self:RegisterEvent("TRAINER_UPDATE")

		self.button.delay = 1
		self.button:SetScript("OnUpdate", BetterSafeThanSorry_OnUpdate)
	else
		self:ResetScript()
	end
end

function TrainAll:TRAINER_UPDATE()
	self.skillsLearned = self.skillsLearned + 1

	if self.skillsLearned >= self.skillsToLearn then
		self:ResetScript()
		self:TrainAllSkills()
	else
		self.button.delay = 1
	end
end

function TrainAll:ResetScript()
	if self.button then
		self.button:SetScript("OnUpdate", nil)
	end

	self:UnregisterEvent("TRAINER_UPDATE")

	self.skillsLearned = nil
	self.skillsToLearn = nil

	if self.button then
		self.button.delay = nil
	end

	self.locked = nil
end

function TrainAll:ButtonCreate()
	if self.button or not ClassTrainerFrame then return end

	self.button = CreateFrame("Button", "ElvUI_TrainAllButton", ClassTrainerFrame, "UIPanelButtonTemplate")
	self.button:Size(80, 22)
	self.button:SetFormattedText("%s %s", TRAIN, ALL)

	if E.private.skins.blizzard.enable and E.private.skins.blizzard.trainer then
		self.button:Point("RIGHT", ClassTrainerTrainButton, "LEFT", -3, 0)
		E:GetModule("Skins"):HandleButton(self.button)
	else
		self.button:Point("RIGHT", ClassTrainerTrainButton, "LEFT")
	end

	self.button:SetScript("OnClick", function()
		TrainAll:TrainAllSkills()
	end)

	self.button:HookScript("OnEnter", function(button)
		local totalCost = 0

		for i = 1, GetNumTrainerServices() do
			if select(3, GetTrainerServiceInfo(i)) == "available" then
				totalCost = totalCost + GetTrainerServiceCost(i)
			end
		end

		GameTooltip:SetOwner(button, "ANCHOR_TOPLEFT", 0, 5)
		GameTooltip:SetText(format("|cffffffff%s|r %s", TABARDVENDORCOST, E:FormatMoney(totalCost, E.db.datatexts.goldFormat or "BLIZZARD", not E.db.datatexts.goldCoins)))
	end)

	self.button:HookScript("OnLeave", function()
		GameTooltip:Hide()
	end)
end

function TrainAll:ButtonUpdate()
	if self.locked or not self.button then return end

	for i = 1, GetNumTrainerServices() do
		if select(3, GetTrainerServiceInfo(i)) == "available" then
			self.button:Enable()
			return
		end
	end

	self.button:Disable()
end

function TrainAll:ButtonPosition(disable)
	if not ClassTrainerFrame or not ClassTrainerTrainButton or not ClassTrainerCancelButton then return end

	if disable then
		ClassTrainerTrainButton:Point("CENTER", ClassTrainerFrame, "TOPLEFT", 221, -417)

		ClassTrainerCancelButton.Show = nil
		ClassTrainerCancelButton:Show()
	else
		ClassTrainerTrainButton:Point("CENTER", ClassTrainerFrame, "TOPLEFT", 304, -417)

		ClassTrainerCancelButton.Show = E.noop
		ClassTrainerCancelButton:Hide()
	end
end

function TrainAll:ADDON_LOADED(_, addon)
	if addon ~= "Blizzard_TrainerUI" or self.button then return end

	self:ButtonCreate()
	self:ButtonPosition()

	self:SecureHook("ClassTrainerFrame_Update", "ButtonUpdate")
	self:UnregisterEvent("ADDON_LOADED")
end

function TrainAll:TRAINER_SHOW()
	if not IsAddOnLoaded("Blizzard_TrainerUI") then
		if ClassTrainerFrame_LoadUI then
			ClassTrainerFrame_LoadUI()
		end

		if not IsAddOnLoaded("Blizzard_TrainerUI") then
			self:RegisterEvent("ADDON_LOADED")
			return
		end
	end

	if not self.button then
		self:ADDON_LOADED(nil, "Blizzard_TrainerUI")
	end

	if self.button then
		self.button:Show()
		self:ButtonPosition()
		self:ButtonUpdate()
	end
end

function TrainAll:Initialize()
	self:RegisterEvent("TRAINER_SHOW")

	if self:EnsureButton() then
		self.button:Show()
		self:ButtonPosition()

		if not self:IsHooked("ClassTrainerFrame_Update") then
			self:SecureHook("ClassTrainerFrame_Update", "ButtonUpdate")
		end
	end
end

local function InitializeCallback()
	TrainAll:Initialize()
end
E:RegisterModule(TrainAll:GetName(), InitializeCallback)

